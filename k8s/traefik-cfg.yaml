apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: traefik
  namespace: kube-system
spec:
  valuesContent: |-
    service:
      spec:
        externalTrafficPolicy: Local 
    logs:
      general:
        level: "INFO"
      access:
        enabled: true
        format: common
        fields:
          defaultMode: keep
          names:
            ServiceName: keep

    ports:
     # web:
     #   redirections:
     #     entryPoint:
     #       to: websecure
     #       scheme: https
     #       permanent: true
      websecure:
        middlewares: #  []
          - crowdsec-main-crowdsec-bouncer

    # Proxy Protocol needs “enabled”, not only trustedIPs
    additionalArguments:
      - --accesslog=true  # double-check logging stays on even if values drift
      #- --accesslog.format=json  # enforce JSON formatting at the CLI level
      - --entrypoints.web.proxyProtocol=true  # enable Proxy Protocol on the HTTP entrypoint
      - --entrypoints.websecure.proxyProtocol=true  # enable Proxy Protocol on the HTTPS entrypoint
      - --entrypoints.web.proxyProtocol.trustedIPs=10.0.0.0/8,192.168.0.0/16  # trust proxy headers from your internal ranges
      - --entrypoints.websecure.proxyProtocol.trustedIPs=10.0.0.0/8,192.168.0.0/16  # same trust list for HTTPS
      - --providers.kubernetesingress  # watch standard Ingress resources
      - --providers.kubernetescrd  # watch Traefik CRD resources

    experimental:
      plugins:
        crowdsec-bouncer:
          moduleName: "github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin"
          version: "v1.5.0-beta1"
